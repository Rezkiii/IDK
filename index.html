<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Survival Boss - Full Level</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        
        /* Start Screen */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto;
        }
        #start-btn {
            padding: 15px 40px; font-size: 24px; background: #00ff00; border: none; color: black;
            cursor: pointer; font-weight: bold; margin-top: 20px; box-shadow: 0 0 15px #00ff00;
        }
        #start-btn:hover { background: white; }

        #info {
            position: absolute; top: 10px; width: 100%; text-align: center; 
            color: #00ff00; text-shadow: 0px 0px 5px #00ff00; font-size: 14px;
        }
        #timer-box {
            position: absolute; top: 50px; width: 100%; text-align: center;
            font-size: 40px; font-weight: bold; color: red; display: none;
            text-shadow: 0 0 10px red;
        }
        #message-box {
            position: absolute; top: 40%; width: 100%; text-align: center;
            font-size: 50px; color: white; display: none; background: rgba(0,0,0,0.8); padding: 20px 0;
            pointer-events: auto; cursor: pointer; border: 2px solid white; z-index: 60;
        }

        /* CONTROLS */
        #joystick-zone {
            position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; z-index: 20; display: none; pointer-events: auto;
        }
        #dash-btn {
            position: absolute; bottom: 60px; right: 40px; width: 80px; height: 80px; 
            background: rgba(0, 255, 255, 0.3); border: 2px solid cyan; border-radius: 50%; 
            color: cyan; font-size: 30px; line-height: 80px; text-align: center;
            font-weight: bold; cursor: pointer; user-select: none; z-index: 20; display: none; pointer-events: auto;
            backdrop-filter: blur(2px); box-shadow: 0 0 10px cyan;
        }
        #dash-btn:active { background: rgba(0, 255, 255, 0.8); color: white; }
        #dash-status {
            position: absolute; bottom: 20px; right: 50px; color: cyan; font-size: 12px; display: none;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white; text-align:center;">DARK DUNGEON 3D</h1>
        <p style="color:#aaa; text-align:center;">Pastikan 'boss.mp3' tersedia</p>
        <button id="start-btn">MULAI GAME</button>
    </div>

    <div id="ui-layer">
        <div id="info">Hindari Obstacle, Cari Tombol Biru...</div>
        <div id="timer-box">SURVIVE: <span id="time-val">40</span>s</div>
        <div id="message-box" onclick="location.reload()">GAME OVER<br><span style="font-size:20px">(Klik untuk Restart)</span></div>
        <div id="dash-status">DASH READY</div>
    </div>
    
    <div id="joystick-zone"></div>
    <div id="dash-btn">âš¡</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

    <script>
        // --- GAME VARIABLES ---
        let gameState = 'WAITING'; 
        let timeLeft = 40;
        let timerInterval;
        let obstacles = []; 
        
        // --- 1. SETUP ENGINE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505); 
        scene.fog = new THREE.Fog(0x050505, 5, 25); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- 2. AUDIO SETUP (REAL MP3) ---
        const bossAudio = new Audio('boss.mp3'); 
        bossAudio.loop = true; 
        bossAudio.volume = 0.6; 

        // --- 3. START BUTTON LOGIC ---
        const startBtn = document.getElementById('start-btn');
        const startScreen = document.getElementById('start-screen');

        startBtn.addEventListener('click', () => {
            // Pancing Audio
            bossAudio.play().then(() => {
                bossAudio.pause();
                bossAudio.currentTime = 0;
            }).catch(e => console.log("Audio warning: " + e));

            startScreen.style.display = 'none';
            gameState = 'EXPLORING';
            
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                document.getElementById('joystick-zone').style.display = 'block';
                document.getElementById('dash-btn').style.display = 'block';
                document.getElementById('dash-status').style.display = 'block';
            }
        });

        // --- 4. PLAYER & OBJECTS ---
        const playerGroup = new THREE.Group();
        const pGeo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const pMat = new THREE.MeshPhongMaterial({ color: 0x00ff00 }); 
        const playerMesh = new THREE.Mesh(pGeo, pMat);
        playerMesh.position.y = 0.4;
        playerMesh.castShadow = true;
        playerGroup.add(playerMesh);

        const face = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.2), new THREE.MeshBasicMaterial({ color: 0x000000 }));
        face.position.set(0, 0.6, -0.4); 
        playerGroup.add(face);

        const flashLight = new THREE.SpotLight(0xffffff, 2, 45, Math.PI / 5, 0.5, 1);
        flashLight.position.set(0, 1, 0);
        flashLight.target.position.set(0, 0, -5);
        flashLight.castShadow = true;
        playerGroup.add(flashLight);
        playerGroup.add(flashLight.target);
        scene.add(playerGroup);

        scene.add(new THREE.AmbientLight(0x222222)); 

        // --- 5. LEVEL GENERATOR ---
        function createWall(x, y, z, w, h, d, color) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({ color: color }));
            mesh.position.set(x, y, z);
            mesh.castShadow = true; mesh.receiveShadow = true;
            scene.add(mesh);
            obstacles.push(mesh); 
            return mesh;
        }

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 250), new THREE.MeshPhongMaterial({ color: 0x111111, side: THREE.DoubleSide }));
        floor.rotation.x = -Math.PI / 2;
        floor.position.z = -50;
        floor.receiveShadow = true;
        scene.add(floor);

        // Dinding Lorong
        for(let i = 0; i < 25; i++) {
            const zPos = -i * 5; 
            createWall(-6, 2, zPos, 2, 4, 5, 0x444444); 
            createWall(6, 2, zPos, 2, 4, 5, 0x444444);  
        }
        createWall(0, 2, 5, 14, 4, 2, 0x444444); 
        createWall(0, 2, -125, 14, 4, 2, 0x444444); 

        // --- GENERATE INITIAL LEVEL (RAMAI TAPI RAPI) ---
        function generateInitialLevel() {
            // Kita buat obstacle dari Z -10 sampai -100
            for(let z = -10; z > -100; z -= 8) { // Jarak per baris obstacle 8 meter
                
                // Pola 1: Kiri dan Kanan (Tengah kosong)
                if (z % 16 === 0) {
                    createWall(-3, 1, z, 2, 2, 2, 0x550000); // Merah Gelap
                    createWall(3, 1, z, 2, 2, 2, 0x550000);
                } 
                // Pola 2: Tengah (Samping kosong)
                else {
                    createWall(0, 1, z, 3, 2, 1, 0x550000);
                }
            }
        }
        generateInitialLevel(); // Panggil saat game start

        // --- GENERATE CHAOS (SAAT BOSS MUNCUL) ---
        function generateChaosMap() {
            const numberOfObstacles = 30; // Tambah 30 obstacle baru secara acak
            for(let i=0; i<numberOfObstacles; i++) {
                const randX = (Math.random() * 10) - 5; 
                const randZ = -(Math.random() * 90) - 10; 
                
                const distToPlayer = Math.sqrt(Math.pow(randX - playerGroup.position.x, 2) + Math.pow(randZ - playerGroup.position.z, 2));

                if(distToPlayer > 8) { 
                    const w = Math.random() * 2 + 1;
                    const h = Math.random() * 3 + 1;
                    // Warna Merah Terang untuk obstacle chaos
                    createWall(randX, h/2, randZ, w, h, 1, 0xff0000); 
                }
            }
        }

        // --- 6. BOSS SETUP ---
        const triggerBtn = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 0.2, 32), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
        triggerBtn.position.set(0, 0.1, -110);
        scene.add(triggerBtn);
        const btnLight = new THREE.PointLight(0x00ffff, 1, 10);
        btnLight.position.set(0, 1, -110);
        scene.add(btnLight);

        const bossGroup = new THREE.Group();
        const bossMesh = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true }));
        bossGroup.add(bossMesh);
        bossGroup.add(new THREE.PointLight(0xff0000, 2, 20));
        bossGroup.position.set(0, -50, 0); 
        scene.add(bossGroup);

        // --- 7. INPUT & LOGIC ---
        let moveForward = false, moveBackward = false, turnLeft = false, turnRight = false;
        let joyVector = { x: 0, y: 0 };
        let canDash = true;
        let isDashing = false;
        const normalSpeed = 0.15;
        const dashSpeed = 0.6; 
        let currentSpeed = normalSpeed;

        function triggerDash() {
            if (!canDash || (gameState !== 'FIGHT' && gameState !== 'EXPLORING')) return;
            isDashing = true; canDash = false; currentSpeed = dashSpeed;
            playerMesh.material.color.setHex(0x00ffff);
            document.getElementById('dash-status').innerText = "COOLDOWN...";
            document.getElementById('dash-status').style.color = "grey";
            
            setTimeout(() => { isDashing = false; currentSpeed = normalSpeed; playerMesh.material.color.setHex(0x00ff00); }, 250);
            setTimeout(() => { canDash = true; document.getElementById('dash-status').innerText = "DASH READY"; document.getElementById('dash-status').style.color = "cyan"; }, 1200);
        }

        document.addEventListener('keydown', (e) => {
            if(gameState === 'LOSE' || gameState === 'WIN') return;
            switch (e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': turnLeft = true; break;
                case 'KeyD': turnRight = true; break;
                case 'ShiftLeft': triggerDash(); break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch (e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': turnLeft = false; break;
                case 'KeyD': turnRight = false; break;
            }
        });

        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            const joyZone = document.getElementById('joystick-zone');
            const manager = nipplejs.create({ zone: joyZone, mode: 'static', position: { left: '50%', top: '50%' }, color: '#00ff00' });
            manager.on('move', (evt, data) => { if (data.vector) { joyVector.x = data.vector.x; joyVector.y = data.vector.y; } });
            manager.on('end', () => { joyVector = { x: 0, y: 0 }; });
            document.getElementById('dash-btn').addEventListener('touchstart', (e) => { e.preventDefault(); triggerDash(); });
        }

        // --- 8. COLLISION & GAME LOOP ---
        const playerBox = new THREE.Box3();
        const tempBox = new THREE.Box3();

        function checkWallCollision() {
            playerBox.setFromObject(playerMesh);
            playerBox.expandByScalar(-0.15); 
            for (let i = 0; i < obstacles.length; i++) {
                tempBox.setFromObject(obstacles[i]);
                if (playerBox.intersectsBox(tempBox)) return true;
            }
            return false;
        }

        function startBossFight() {
            gameState = 'FIGHT';
            scene.remove(triggerBtn);
            scene.remove(btnLight);
            
            bossGroup.position.set(0, 2, -120); 

            // PLAY AUDIO MP3
            bossAudio.play().catch(error => {
                console.log("Gagal memutar audio (Cek Live Server): " + error);
            });

            generateChaosMap(); // Tambah obstacle lagi
            
            const info = document.getElementById('info');
            info.innerHTML = "OBSTACLE MUNCUL! LARI!";
            info.style.color = "red";
            document.getElementById('timer-box').style.display = "block";

            timerInterval = setInterval(() => {
                if (gameState !== 'FIGHT') { clearInterval(timerInterval); return; }
                timeLeft--;
                document.getElementById('time-val').innerText = timeLeft;
                if (timeLeft <= 0) gameWin();
            }, 1000);
        }

        function gameWin() {
            gameState = 'WIN';
            clearInterval(timerInterval);
            bossAudio.pause();
            bossAudio.currentTime = 0;

            const msg = document.getElementById('message-box');
            msg.innerHTML = "YOU SURVIVED!<br><span style='font-size:20px; color:green'>Klik untuk Main Lagi</span>";
            msg.style.display = "block";
            msg.style.borderColor = "green";
            scene.remove(bossGroup);
        }

        function gameOver() {
            if(gameState === 'LOSE') return;
            gameState = 'LOSE'; 
            clearInterval(timerInterval);
            bossAudio.pause();
            bossAudio.currentTime = 0;

            const msg = document.getElementById('message-box');
            msg.innerHTML = "YOU DIED<br><span style='font-size:20px; color:red'>Klik untuk Restart</span>";
            msg.style.display = "block";
            msg.style.borderColor = "red";
        }

        // --- ANIMATION ---
        const bossSpeed = 0.135; 
        const cameraOffset = new THREE.Vector3(0, 5, 8); 

        function animate() {
            requestAnimationFrame(animate);

            if (gameState === 'EXPLORING' || gameState === 'FIGHT') {
                if (turnLeft || joyVector.x < -0.1) playerGroup.rotation.y += 0.05;
                if (turnRight || joyVector.x > 0.1) playerGroup.rotation.y -= 0.05;

                let drive = 0;
                if (isDashing) drive = 1;
                else {
                    if (moveForward) drive = 1;
                    if (moveBackward) drive = -1;
                    if (Math.abs(joyVector.y) > 0.1) drive = joyVector.y;
                }

                if (Math.abs(drive) > 0) {
                    const oldX = playerGroup.position.x;
                    const oldZ = playerGroup.position.z;
                    const angle = playerGroup.rotation.y;
                    
                    playerGroup.position.x -= Math.sin(angle) * currentSpeed * drive;
                    playerGroup.position.z -= Math.cos(angle) * currentSpeed * drive;

                    playerGroup.updateMatrixWorld();
                    if (checkWallCollision()) {
                        playerGroup.position.x = oldX;
                        playerGroup.position.z = oldZ;
                    }
                }

                if (gameState === 'EXPLORING') {
                    if (playerGroup.position.distanceTo(triggerBtn.position) < 2) {
                        startBossFight();
                    }
                }

                if (gameState === 'FIGHT') {
                    const direction = new THREE.Vector3().subVectors(playerGroup.position, bossGroup.position);
                    direction.y = 0; 
                    direction.normalize();
                    bossGroup.position.add(direction.multiplyScalar(bossSpeed));
                    
                    bossGroup.rotation.y += 0.1; 
                    bossGroup.rotation.z += 0.05;

                    if (bossGroup.position.distanceTo(playerGroup.position) < 2.5) {
                        gameOver();
                    }
                }
            }

            const relativeCameraOffset = cameraOffset.clone().applyMatrix4(playerGroup.matrixWorld);
            const lerpFactor = isDashing ? 0.04 : 0.1;
            camera.position.lerp(relativeCameraOffset, lerpFactor);
            camera.lookAt(playerGroup.position);

            renderer.render(scene, camera);
        }

        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
